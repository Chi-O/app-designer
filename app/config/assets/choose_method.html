<html>
    <head>
        <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
        <link href="css/index.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="libs/jquery.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>
        <script type="text/javascript" src="../../config/assets/js/util.js"></script>
        <script type="text/javascript">
        var insideQueue = false;
        var htmlFileNameValue = "delivery_start";
        var userActionValue = "launchBarcode";
        var myTimeoutVal = null;
        var idComponent = "";
        var roles;
        var users;
        var USER_TAG = 'Please Select User';
        var superUser;
        var type = util.getQueryParameter('type');


        function display() {
            $('#choose_user').hide();
            if (type != 'ent_override') {
                $('#view_details').hide();
            } else {
                idComponent = "&authorization_id=" + encodeURIComponent(util.getQueryParameter('authorization_id'));
                $('#view_details').on('click', function() {
                   odkTables.openDetailView(
                  'authorizations',
                  util.getQueryParameter('authorization_id'),
                  'config/tables/authorizations/html/authorizations_detail.html');
                });
            }
            odkData.getUsers(userSuccess, userFailure);
        }

        function userSuccess(result) {
            users = result.getUsers();
            odkData.getRoles(rolesCBSuccess, rolesCBFailure);
        }

        function userFailure(error) {
            console.log('userFailure with error: ' + error);
        }

        function rolesCBFailure(error) {
            console.log('roles failure with error: ' + error);
        }
        function rolesCBSuccess(result) {
            roles = result.getRoles();
            superUser = $.inArray('ROLE_SUPER_USER_TABLES', roles) > -1;
            if (superUser && type != 'ent_override' && type != 'activate' && type != 'disable') {
                $('#choose_user').show();
                $('#barcode').prop("disabled", true).addClass('disabled');
                $('#manual').prop("disabled", true).addClass('disabled');
                console.log(users);
                users.forEach(addOption);
                $('#choose_user').append($("<option/>").attr("value", USER_TAG).attr('selected', true).text(USER_TAG));
                $('#choose_user').on('change', function() {
                    if ($('#choose_user').val() != USER_TAG) {
                        //$('#barcode').prop("disabled", false).removeClass('disabled');
                        $('#manual').prop("disabled", false).removeClass('disabled');
                    } else {
                        $('#barcode').prop("disabled", true).addClass('disabled');
                        $('#manual').prop("disabled", true).addClass('disabled');
                    }
                });
            }
            

            $('#title').text(util.getQueryParameter('title'));

            $('#barcode').on('click', function() {
                odkCommon.registerListener(function() {
                        callBackFn();
                });
                var dispatchString = JSON.stringify({htmlPath:htmlFileNameValue, userAction:userActionValue});
                odkCommon.doAction(dispatchString, 'com.google.zxing.client.android.SCAN', null);
            });
            myTimeoutVal = setTimeout(callBackFn(), 1000);


            $('#manual').on('click', function() {
                var url = 'config/assets/manual.html?title=' + encodeURIComponent(util.getQueryParameter('secondary_manual_title')) + '&type=' + encodeURIComponent(type) + idComponent;
                if (superUser) {
                    url += '&user=' + encodeURIComponent($('#choose_user').val());
                }
                odkTables.launchHTML(url);
            });
        }

        function addOption(item, index) {
            if ($.inArray("ROLE_USER", item.roles) > -1 && $.inArray("ROLE_SUPER_USER_TABLES", item.roles) == -1) {
                $('#choose_user').append($("<option/>").attr("value", item.user_id).text(item.full_name));
            }
        }

        function callBackFn () {
            if (insideQueue == true) return;
            insideQueue = true;
            var value = odkCommon.viewFirstQueuedAction();
            console.log('callback entered with value: ' + value);
            if ( value !== null && value !== undefined ) {
                var action = JSON.parse(value);
                var dispatchStr = JSON.parse(action.dispatchString);

                console.log("callBackFn: action: " + dispatchStr.userAction + " htmlPath: " + dispatchStr.htmlPath);

                if (dispatchStr.userAction === userActionValue &&
                    dispatchStr.htmlPath === htmlFileNameValue &&
                    action.jsonValue.status === -1) {
                    clearTimeout(myTimeoutVal);
                    url = 'config/assets/scan.html?code=' + encodeURIComponent(action.jsonValue.result.SCAN_RESULT) +
                        '&type=' + encodeURIComponent(util.getQueryParameter('type')) + idComponent;
                    if (superUser) {
                        url += '&user=' + encodeURIComponent($('#choose_user').val());
                    }
                    odkTables.launchHTML(url);
                    odkCommon.removeFirstQueuedAction();

                }
            }
        }

        </script>
    </head>

    <body onload="display()">
        <div id="main">
            <h1 id="title"></h1>
            <select id="choose_user" class="dropdown" display='none'>
            </select>
            <button type="reg" id='barcode'>Scan Barcode</button>
            <button type ='reg' id='manual'>Manually Enter</button>
            <button type ='reg' id='view_details'>View Authorization Details</button>
        </div>
        <div id="logo"><img src="img/small_2025.jpg"></div>
    </body>
</html>
