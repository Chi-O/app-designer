<html>
    <head>
        <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
        <link href="css/index.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="libs/jquery.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>
        <script type="text/javascript">

        var sqlWhereClause = null;
        var sqlSelectionArgs = null;
        var windowHeight = $(window).innerHeight();
        //var search;
        var search_font;
        function start() {
            odkData.query('deliveries', null, null, null, null, null, null, 
                                    null, null, null, populateSuccess, populateFailure);
            search_font = $('#search').css('font-size');
        }

        function populateSuccess(result) {
            var columns = result.getColumns();
            columns.forEach(addField);
        }

        function populateFailure(error) {
            console.log('populateFailure with error: ' + error);
        }

        function addField(item, index) {
            if (!item.startsWith('_')) {
                $('#field').append($("<option/>").attr("value", item).text(item));
            } 
        }

        function search() {
            sqlWhereClause = document.getElementById('field').value +' = ?';
            sqlSelectionArgs = document.getElementById('value').value;
            odkData.query('deliveries', sqlWhereClause, [sqlSelectionArgs],
            null, null, null, null, null, null, null,
            successCallbackFn, failureCallbackFn);
        }

        function successCallbackFn(result) {
            document.getElementById('search_results').innerHTML = result.getCount() + ' deliveries found!';
            if (result.getCount() > 0) {
                document.getElementById('launch').style.display='block';
            } else {
                document.getElementById('launch').style.display='none';
            }
        }

        function failureCallbackFn(error) {
            document.getElementById('search_results').innerHTML = 'invalid field!';
            document.getElementById('launch').style.display='none';
        }

        function launch() {
            console.log(sqlWhereClause + ' ---- ' + sqlSelectionArgs);
                odkTables.openTableToListView('deliveries', sqlWhereClause,
                    [sqlSelectionArgs], 'config/tables/deliveries/html/deliveries_list.html');
        }

        $(window).resize(function() {
            helper('search', search_font, 'font-size');
            windowHeight = $(window).innerHeight(); 

        });

        function helper(name, value, attribute) {
           var viewportHeight = $(window).innerHeight();
            if (viewportHeight < windowHeight) {
                console.log('set ' + name + '\'s ' + attribute + ' to ' + value);
                if (attribute == 'height') {
                    $('#' + name).css({'height':value});
                } else {
                    $('#' + name).css({'font-size':value});
                }
            }
        }
        
        </script>
    </head>

    <body onload="start()">
        <div id="main">
            <h1 id="title">Search for Deliveries</h1>
            <form>    
                <select id="field"></select>
            </form>
            <form>
                <input type="text" id="value" placeholder="Enter a value for this field">
            </form>
            <button type="reg" id="search" onclick="search()">Search</button>
            <br>
            <p id="search_results"></p>
            <button type = 'reg' id='launch' style='display:none;' onclick='launch()'>View Matching Deliveries</button>
        </div>
    </body>
</html>
