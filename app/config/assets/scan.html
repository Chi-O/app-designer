<html>
    <head>
        <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
        <link href="css/index.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="libs/jquery.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>
        <script type="text/javascript" src="../../config/assets/js/util.js"></script>
        <script type="text/javascript">

            var code = util.getQueryParameter('code');
            var type = util.getQueryParameter('type');

            function display() {
                $('#header').text('Scanned Barcode: ' + code);
                if (type == 'delivery') {
                    deliveryFunction();
                } else if (type == 'registration') {
                    registrationFunction();
                } else if (type == 'voucher') {
                    voucherFunction();
                } else if (type == 'activate' || type == 'disable') {
                    regOverrideFunction();
                } else if (type == 'ent_override') {
                    entOverrideFunction();
                }

            }
            function deliveryFunction() {
                odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, 'true'], null, null,
                                    null, null, null, null, true, deliveryBCheckCBSuccess, 
                                    deliveryBCheckCBFailure);
            }

            function deliveryBCheckCBSuccess(result) {
                console.log('deliveryBCheckCBSuccess called');
                if (result.getCount() === 0) {
                    odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, 'false'],
                        null, null, null, null, null, null, true, deliveryDisabledCBSuccess, deliveryDisabledCBFailure);
                } else if (result.getCount() === 1) {
                    $('#search_results').text('Scanned Barcode:' + code);
                    $('#launch').show();
                    $('#launch').text('View Entitlements');
                    $('#launch').click(function() {
                        odkTables.openDetailView(
                      'registration',
                      result.getRowId(0),
                      'config/tables/registration/html/registration_detail.html?type=' + type);
                    });
                    odkCommon.removeFirstQueuedAction();
                } else {
                    $('#search_results').text(code + ' -- Multiple Active Beneficiaries Detected!');
                    $('#launch').show();
                    $('#launch').text('Choose a specific beneficiary');
                    $('#launch').click(function() {
                        odkTables.openTableToListView(
                        'registration', 'beneficiary_code = ? and is_active = ?', [code,'true']
                        , 'config/tables/registration/html/registration_list.html?type=' + type);
                    });
                    odkCommon.removeFirstQueuedAction();                
                }
            }

            function deliveryBCheckCBFailure(error) {
                console.log('deliveryBCheckCBFailure called with error: ' + error);
            }

            function deliveryDisabledCBSuccess(result) {
                console.log('disabledCB called');
                if (result.getCount() > 0) {
                    $('#search_results').text('beneficiary with code \'' + code +'\' is disabled');
                } else {
                    $('#search_results').text('Scanned code not found in system');

                }
                $('#launch').hide();
                odkCommon.removeFirstQueuedAction();
            }

            function deliveryDisabledCBFailure(error) {
                console.log('disableCB failed with error: ' + error);
            }

            function registrationFunction() {
                console.log('registration function path entered');
                 odkData.query('registration', 'beneficiary_code = ?', [code], null, null,
                                null, null, null, null, true, registrationBCheckCBSuccess, 
                                registrationBCheckCBFailure);
            }

            function registrationBCheckCBSuccess(result) {
                console.log('registrationBCheckCBSuccess called with value' + result);
                if (result.getCount() === 0) {
                    odkData.query('entitlements', 'beneficiary_code = ?', [code], null, null,
                        null, null, null, null, true, registrationVoucherCBSuccess, registrationVoucherCBFailure);

                } else {
                    $('#search_results').text('Barcode \'' + code + '\' Unavailable: please scan a different barcode');
                    $('#launch').hide();
                    odkCommon.removeFirstQueuedAction();
                }
            }

            function registrationBCheckCBFailure(error) {
                console.log('registrationBCheckCBFailure called with error: ' + error);
            }

            function registrationVoucherCBSuccess(result) {
                voucherResultSet = result;
                if (voucherResultSet.getCount() == 0) {
                    $('#search_results').text('Barcode \'' + code + '\' Available');
                    $('#launch').show();
                    $('#launch').text('Click to Register Beneficiary');
                    $('#launch').click(function() {
                        odkTables.addRowWithSurvey(
                      'registration',
                      'registration',
                      null,
                      getJSONMapValues());
                    });
                    odkCommon.removeFirstQueuedAction();
                } else {
                    $('#search_results').text('Voucher Detected for Barcode \'' + code + '\': Did you mean to redeem voucher?');
                    $('#launch').hide();
                    odkCommon.removeFirstQueuedAction();
                }
            }

            function registrationVoucherCBFailure(error) {
                console.log('registrationVoucherCBFailure called with error: ' + error);
            }

            var setJSONMap = function(JSONMap, key, value) {
                if (value !== null && value !== undefined) {
                    JSONMap[key] = JSON.stringify(value);
                }
            }

            var getJSONMapValues = function() {
                var jsonMap = {};
                setJSONMap(jsonMap, 'beneficiary_code', code);
                jsonMap = JSON.stringify(jsonMap);    
                return jsonMap;
            };

            function voucherFunction() {
                odkData.query('registration', 'beneficiary_code = ?', [code], null, null,
                                null, null, null, null, true, voucherBCheckCBSuccess, voucherBCheckCBFailure);
            }

            function voucherBCheckCBSuccess(result) {
                console.log('voucherBCheckCBSuccess called');
                if (result.getCount() === 0) {
                    console.log("Count = 0");
                    odkData.query('entitlements', 'beneficiary_code = ?', [code],
                        null, null, null, null, null, null, true, voucherSelfCBSuccess, voucherSelfCBFailure);
                } else {
                    console.log("count > 0");
                    $('#search_results').text(code + " -- beneficiary with this code already detected in system: please contact Administrator");
                }
            }

            function voucherBCheckCBFailure(error) {
                console.log('voucherBCheckCBFailure called with error: ' + error);
            }

            function voucherSelfCBSuccess(result) {
                console.log('voucherSelfCBSuccess called');
                if (result.getCount() === 0) {
                    $('#search_results').text('Scanned voucher code not found in system');
                } else {
                    $('#search_results').text(code + ' -- Voucher Detected!');
                    $('#launch').show();
                    $('#launch').text('Redeem Voucher');
                    $('#launch').click(function() {
                        odkTables.addRowWithSurvey(
                        'registration', 'registration', null, getJSONMapValues());
                    });
                }
                odkCommon.removeFirstQueuedAction();
            }

            function voucherSelfCBFailure(error) {
                console.log('activeCBFailure called with error: ' + error);
            }

            function regOverrideFunction() {
                console.log('entered regoverride path');
                if (code !== "") {
                    console.log(code);
                    if (type == 'activate') {
                        queriedType = 'false';
                    } else {
                        queriedType = 'true';
                    }
                    odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, queriedType], null, null,
                                    null, null, null, null, true, regOverrideBenSuccess, regOverrideBenFailure);
                }

            }

            function regOverrideBenSuccess(result) {
                var descriptor;
                    if (type == 'activate') {
                        descriptor = "Disabled";
                    } else {
                        descriptor = "Active";
                    }
                if (result.getCount() == 1) {
                    $('#search_results').text(descriptor + ' Beneficiary Detected');
                    $('#launch').show();
                    $('#launch').text('View Beneficiary');
                    $('#launch').click(function () {
                        odkTables.openDetailView('registration', result.getRowId(0),
                            'config/tables/registration/html/registration_detail.html?type=' + encodeURIComponent(type));
                    });
                } else if (result.getCount() > 1) {
                    $('#search_results').text('Multiple ' + descriptor + ' Beneficiaries Detected');
                    $('#launch').show();
                    $('#launch').text('View Beneficiaries');
                    $('#launch').click(function () {
                        odkTables.openTableToListView(
                            'registration',
                            'beneficiary_code = ? and is_active = ?',
                            [code, queriedType],
                            'config/tables/registration/html/registration_list.html?type=' + encodeURIComponent(type));
                    });
                } else {
                    $('#search_results').text('No ' + descriptor + ' Beneficiary Detected');
                }
            }

            function regOverrideBenFailure(error) {
                console.log('regOverrideFailure with error : ' + error)
            }

            function entOverrideFunction() {
                if (code !== "") {
                    odkData.query('registration', 'beneficiary_code = ?', 
                        [code],
                        null, null, null, null, null, null, true, benEntOverrideCBSuccess, benEntOverrideCBFailure);
                } else {
                    $('#search_results').text("Please Enter Beneficiary Code");
                }
            }

            function benEntOverrideCBSuccess(result) {
                if (result.getCount() != 0) {
                    odkData.query('entitlements', 'beneficiary_code = ? and authorization_id = ?', 
                                [code, util.getQueryParameter('authorization_id')],
                                null, null, null, null, null, null, true, entCheckCBSuccess, entCheckCBFailure);
                } else {
                    $('#search_results').text('Beneficiary code (' + code
                                          + ') not found in system.');
                    odkCommon.removeFirstQueuedAction();
                }
            }

            function benEntOverrideCBFailure(error) {
                console.log('failed with error: ' + error);
            }

            function entCheckCBSuccess(result) {
                var isEmpty = true;
                for (var key in result) {
                    if (Object.prototype.hasOwnProperty.call(result, key)) {
                        isEmpty = false;
                    }
                }
                if (result.getCount() == 0) {
                    odkData.query('authorizations', '_id = ?', 
                                [util.getQueryParameter('authorization_id')],
                                null, null, null, null, null, null, true, createOverrideCBSuccess, createOverrideCBFailure);
                } else {
                    $('#search_results').text('Scanned beneficiary already qualifies for this authorization');
                }
            }

            function entCheckCBFailure(error) {
                console.log('scanCBFailure with error:' + error);
            }

            function createOverrideCBSuccess(result) {
                $('#search_results').text('Beneficiary Eligible for Entitlement Override');

                var struct = {};
                struct['authorization_id'] = result.get('_id');
                struct['authorization_name'] = result.get('authorization_name');
                struct['item_pack_id'] = result.get('item_pack_id');
                struct['item_pack_name'] = result.get('item_pack_name');
                struct['item_description'] = result.get('item_description');
                struct['ranges'] = result.get('ranges');
                struct['beneficiary_code'] = code;
                struct['is_delivered'] = 'false';
                struct['is_override'] = 'true';

                $('#launch').text('Create Entitlement');
                $('#launch').show();
                $('#launch').click(function() {
                   odkData.addRow(
                   'entitlements', struct, util.genUUID(), addDistCBSuccess, addDistCBFailure); 
                });
            }

            function createOverrideCBFailure(error) {
                console.log('createOverride failed with error: ' + error);
            }

            var addDistCBSuccess = function(result) {
                console.log('authorizations_detail addDistCBSuccess');
                $('#search_results').text('Override Successfully Created');
            };

            var addDistCBFailure = function(error) {
                console.log('authorizations_detail addDistCBFailure: ' + error);
            };

        </script>
    </head>


    
    <body onload="display();">
        <div id="main">           
            <h2 id='header'></h2>
            <p><span id="search_results"></span></p>
            <button id="launch" style='display:none'style='font-size: 25px'></button>
        </div>
    </body>