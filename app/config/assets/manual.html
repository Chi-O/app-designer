<html>
    <head>
        <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
        <link href="css/index.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="libs/jquery.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>
        <script type="text/javascript" src="../../config/assets/js/util.js"></script>
        <script type="text/javascript">

        var code = null;
        var id = null;
        var type = util.getQueryParameter('type');
        var queriedType;
        var superUser = util.getQueryParameter('user') != null;
        var user;
        if (superUser) {
            console.log('superUser');
            user = decodeURIComponent(util.getQueryParameter('user'));
        }


        var newVoucherReg;



        function display() {
            $('#header').text(util.getQueryParameter('title'));
            var enter = $('#search');
            var clickFunction;
            if (type == 'delivery') {
                clickFunction = deliveryFunction;
            } else if (type == 'registration') {
                clickFunction = registrationFunction;
            } else if (type == 'voucher') {
                clickFunction = voucherFunction;
            } else if (type == 'activate' || type == 'disable') {
                clickFunction = regOverrideFunction;
            } else if (type == 'ent_override') {
                clickFunction = entOverrideFunction;
            }

            if (clickFunction != null) {
                enter.on('click', clickFunction);
                console.log('click set to ' + type);
            }
        }

        function deliveryFunction() {
            console.log('entered delivery path');
            code = $('#code').val();
            if (code !== "") {
                console.log(code); 
                if (superUser) {
                    odkData.query('registration', 'beneficiary_code = ? and is_active = ? and _filter_value = ?', [code, 'true', user], null, null,
                                null, null, null, null, true, beneficiaryCBSuccess, 
                                beneficiaryCBFailure);   
                } else {
                    odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, 'true'], null, null,
                        null, null, null, null, true, beneficiaryCBSuccess, 
                        beneficiaryCBFailure);   
                }
  
            }
        }

        function beneficiaryCBSuccess(result) {
            console.log('beneficiaryCBSuccess called');
            if (result.getCount() === 0) {
                if (superUser) {
                    console.log(user);
                    odkData.query('registration', 'beneficiary_code = ? and is_active = ? and _filter_value = ?', [code, 'false', user],
                        null, null, null, null, null, null, true, disabledCBSuccess, disabledCBFailure);
                } else {
                    odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, 'false'],
                        null, null, null, null, null, null, true, disabledCBSuccess, disabledCBFailure);
                }
            } else if (result.getCount() === 1) {
                $('#launch').show();
                $('#launch').text('Verify Beneficiary Information');
                $('#launch').click(function() {
                    odkTables.openDetailView(
                  'registration',
                  result.getRowId(0),
                  'config/tables/registration/html/registration_detail.html?type=' + type);
                });
                odkCommon.removeFirstQueuedAction();
            } else {
                $('#search_results').text(code + ' -- Multiple Active Beneficiaries Detected!');
                $('#launch').show();
                $('#launch').text('Choose a specific beneficiary');
                var params;
                var vals;
                if (superUser) {
                    params = 'beneficiary_code = ? and is_active = ? and _filter_value = ?';
                    vals = [code,'true', user];
                } else {
                    params = 'beneficiary_code = ? and is_active = ?';
                    vals = [code,'true'];
                }
                $('#launch').click(function() {
                    odkTables.openTableToListView(
                    'registration', params, vals
                    , 'config/tables/registration/html/registration_list.html?type=' + type);
                });
                odkCommon.removeFirstQueuedAction();                
            }
        }

        function beneficiaryCBFailure(error) {
            console.log('beneficiaryCBFailure called with error: ' + error);
        }

        function disabledCBSuccess(result) {
            console.log('disabledCB called');
            if (result.getCount() > 0) {
                $('#search_results').text('This Beneficiary is Disabled');
            } else {
                $('#search_results').text('Beneficiary code not found in system');

            }
            $('#launch').hide();
            odkCommon.removeFirstQueuedAction();
        }

        function disabledCBFailure(error) {
            console.log('disableCB failed with error: ' + error);
        }


        function registrationFunction() {
            console.log('entered registration path');
            code = $('#code').val();
            if (code !== "") {
                if (superUser) {
                    odkData.query('registration', 'beneficiary_code = ? and _filter_value = ?', [code, user], null, null,
                                null, null, null, null, true, registrationCBSuccess, 
                                registrationCBFailure);
                } else {
                    odkData.query('registration', 'beneficiary_code = ?', [code], null, null,
                                    null, null, null, null, true, registrationCBSuccess, 
                                    registrationCBFailure);  
                }         
            }
        }

        function registrationCBSuccess(result) {
            console.log('beneficiaryCBSuccess called with value' + result);
            if (result.getCount() === 0) {
                if (superUser) {
                    odkData.query('entitlements', 'beneficiary_code = ? and _filter_type = ?', [code, "READ_ONLY"], null, null,
                        null, null, null, null, true, voucherCheckCBSuccess, voucherCheckCBFailure);
                } else {
                    odkData.query('entitlements', 'beneficiary_code = ?', [code], null, null,
                        null, null, null, null, true, voucherCheckCBSuccess, voucherCheckCBFailure);
                }
            } else {
                $('#search_results').text('Barcode Unavailable: please enter a different barcode');
                $('#launch').hide();
                odkCommon.removeFirstQueuedAction();
            }
        }

        function registrationCBFailure(error) {
            console.log('beneficiaryCBFailure called with error: ' + error);
        }

        function voucherCheckCBSuccess(result) {
            if (result.getCount() == 0) {
                $('#search_results').text('Barcode Available');
                $('#launch').show();
                $('#launch').text('Click to Register Beneficiary');
                   
                $('#launch').click(function() {
                    
                    if (superUser) {
                        var struct = {};
                        struct['beneficiary_code'] = code;
                        odkData.addRow('registration', struct, util.genUUID(), proxyRowSuccess, proxyRowFailure);
                    } else {
                        var jsonMap = {};
                        setJSONMap(jsonMap, 'beneficiary_code', code);
                        jsonMap = JSON.stringify(jsonMap);
                        odkTables.addRowWithSurvey('registration', 'registration', null, jsonMap);
                    }
                  
                });
                odkCommon.removeFirstQueuedAction();
            } else {
                $('#search_results').text('Voucher Detected: Did you mean to redeem voucher?');
                $('#launch').hide();
                odkCommon.removeFirstQueuedAction();
            }
        }

        function proxyRowSuccess(result) {
            console.log('made it!');
            odkData.changeAccessFilterOfRow('registration', 'HIDDEN', user, result.getRowId(0), setFilterSuccess, setFilterFailure);
        }

        function proxyRowFailure(error) {
            console.log('proxy set failure with error: ' + error);
        }

        function setFilterSuccess(result) {
            odkTables.editRowWithSurvey('registration', result.getRowId(0), 'registration', null);
        }

        function setFilterFailure(error) {
            console.log('set filter failure with error: ' + error);
        }

        function voucherCheckCBFailure(error) {
            console.log('voucherCBFailure called with error: ' + error);
        }

        var setJSONMap = function(JSONMap, key, value) {
            if (value !== null && value !== undefined) {
                JSONMap[key] = JSON.stringify(value);
            }
        }

        function voucherFunction() {
            console.log('entered voucher path');
            code = $('#code').val();
            if (code !== "") {
                odkData.query('registration', 'beneficiary_code = ?', [code], null, null,
                                null, null, null, null, true, beneficiaryCheckCBSuccess, beneficiaryCheckCBFailure);           
            }
        }

        function beneficiaryCheckCBSuccess(result) {
            console.log('beneficiaryCBSuccess called');
            if (result.getCount() === 0) {
                odkData.query('entitlements', 'beneficiary_code = ?', [code],
                    null, null, null, null, null, null, true, voucherCBSuccess, voucherCBFailure);
            } else {
                $('#search_results').text(code + " -- beneficiary with this code already detected in system: please contact Administrator");
            }
        }

        function beneficiaryCheckCBFailure(error) {
            console.log('beneficiaryCBFailure called with error: ' + error);
        }

        function voucherCBSuccess(result) {
            console.log('voucherCBSuccess called');
            if (result.getCount() === 0) {
                $('#search_results').text('Scanned voucher code not found in system');
            } else {
                $('#search_results').text(code + ' -- Voucher Detected!');
                $('#launch').show();
                $('#launch').text('Redeem Voucher');
                if (superUser) {
                    var struct = {};
                    struct['beneficiary_code'] = code;
                    $('#launch').click(function() {
                        odkData.addRow('registration', struct, util.genUUID(), proxyVoucherSuccess, proxyVoucherFailure);
                    });
                        
                     
                } else {
                    var jsonMap = {};
                    setJSONMap(jsonMap, 'beneficiary_code', code);
                    jsonMap = JSON.stringify(jsonMap);    
                    $('#launch').click(function() {
                        odkTables.addRowWithSurvey(
                        'registration', 'registration', null, jsonMap);
                    });
                }
            }
            odkCommon.removeFirstQueuedAction();
        }

        function voucherCBFailure(error) {
            console.log('activeCBFailure called with error: ' + error);
        }

        function proxyVoucherSuccess(result) {
            odkData.changeAccessFilterOfRow('registration', 'HIDDEN', user, result.getRowId(0), setVoucherFilterSuccess, setVoucherFilterFailure);
            //setJSONMap(jsonMap, '_filter_value', decodeURIComponent(util.getQueryParameter('user')));

            //odkData.changeAccessFilterOfRow(tableId, filterType, filterValue, rowId,
        }

        function proxyVoucherFailure(error) {
            console.log('proxy set failure with error: ' + error);
        }

        function setVoucherFilterSuccess(result) {
            newVoucherReg = result.getRowId(0);
            odkData.query('entitlements', 'beneficiary_code = ?', [code], null, null,null, null, null, null, true, entitlementFindSuccess, entitlementFindFailure);
        }

        function setVoucherFilterFailure(error) {
            console.log('set filter failure with error: ' + error);
        }

        function entitlementFindSuccess(result) {
            for (var i = 0; i < result.getCount() - 1; i++) {
                odkData.changeAccessFilterOfRow('entitlements', 'HIDDEN', user, result.getRowId(i), voucherEntitlementUpdateSuccess, voucherEntitlementUpdateFailure);
            }
            odkData.changeAccessFilterOfRow('entitlements', 'HIDDEN', user, result.getRowId(result.getCount() - 1), finalUpdateSuccess, finalUpdateFailure);

        }

        function entitlementFindFailure(error) {
            console.log('entitlement find failure with error: ' + error);
        }

        function voucherEntitlementUpdateSuccess(result) {
            console.log('update voucher entitlement success');
        }

        function voucherEntitlementUpdateFailure(error) {
            console.log('update voucher entitlement failure with error: ' + error);
        }

        function finalUpdateSuccess(result) {
            odkTables.editRowWithSurvey('registration', newVoucherReg, 'registration', null)
        }

        function finalUpdateFailure(error) {
            console.log('final update failure with error: ' + error);
        }

        function regOverrideFunction() {
            console.log('entered regoverride path');
            code = $('#code').val();
            if (code !== "") {
                console.log(code);
                if (type == 'activate') {
                    queriedType = 'false';
                } else {
                    queriedType = 'true';
                }
                console.log('queriedType ')
                odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, queriedType], null, null,null, null, null, null, true, regOverrideBenSuccess, regOverrideBenFailure);
            }
        }

        function regOverrideBenSuccess(result) {
            var descriptor;
                if (type == 'activate') {
                    descriptor = "Disabled";
                } else {
                    descriptor = "Active";
                }
            if (result.getCount() == 1) {
                $('#search_results').text(descriptor + ' Beneficiary Detected');
                $('#launch').show();
                $('#launch').text('View Beneficiary');
                $('#launch').click(function () {
                    odkTables.openDetailView('registration', result.getRowId(0),
                        'config/tables/registration/html/registration_detail.html?type=' + encodeURIComponent(type));
                });
            } else if (result.getCount() > 1) {
                $('#search_results').text('Multiple ' + descriptor + ' Beneficiaries Detected');
                $('#launch').show();
                $('#launch').text('View Beneficiaries');
                $('#launch').click(function () {
                    odkTables.openTableToListView(
                        'registration',
                        'beneficiary_code = ? and is_active = ?',
                        [code, queriedType],
                        'config/tables/registration/html/registration_list.html?type=' + encodeURIComponent(type));
                });
            } else {
                $('#search_results').text('No ' + descriptor + ' Beneficiary Detected');
            }
        }

        function regOverrideBenFailure(error) {
            console.log('regOverrideFailure with error : ' + error)
        }

        function entOverrideFunction() {
            code = $('#code').val();
            if (code !== "") {
                odkData.query('registration', 'beneficiary_code = ? and _filter_value = ?', 
                    [code, user],
                    null, null, null, null, null, null, true, benEntOverrideCBSuccess, benEntOverrideCBFailure);
            } else {
                $('#search_results').text("Please Enter Beneficiary Code");
            }
        }

        function benEntOverrideCBSuccess(result) {
            if (result.getCount() != 0) {
                odkData.query('entitlements', 'beneficiary_code = ? and authorization_id = ? and _filter_value = ?', 
                            [code, util.getQueryParameter('authorization_id'), user],
                            null, null, null, null, null, null, true, entCheckCBSuccess, entCheckCBFailure);
            } else {
                $('#search_results').text('Beneficiary code (' + code
                                      + ') not found in system.');
                odkCommon.removeFirstQueuedAction();
            }
        }

        function benEntOverrideCBFailure(error) {
            console.log('failed with error: ' + error);
        }

        function entCheckCBSuccess(result) {
            if (result.getCount() == 0) {
                odkData.query('authorizations', '_id = ?', 
                            [util.getQueryParameter('authorization_id')],
                            null, null, null, null, null, null, true, createOverrideCBSuccess, createOverrideCBFailure);
            } else {
                $('#search_results').text('Scanned beneficiary already qualifies for this authorization. Override not created.');
            }
        }

        function entCheckCBFailure(error) {
            console.log('scanCBFailure with error:' + error);
        }

        function createOverrideCBSuccess(result) {
            $('#search_results').text('Beneficiary Eligible for Entitlement Override');
            var struct = {};
                struct['authorization_id'] = result.get('_id');
                struct['authorization_name'] = result.get('authorization_name');
                struct['item_pack_id'] = result.get('item_pack_id');
                struct['item_pack_name'] = result.get('item_pack_name');
                struct['item_description'] = result.get('item_description');
                struct['ranges'] = result.get('ranges');
                struct['beneficiary_code'] = code;
                struct['is_delivered'] = 'false';
                struct['is_override'] = 'true';
                $('#launch').text('Create Entitlement');
                $('#launch').show();
                $('#launch').click(function() {
                   odkData.addRow(
                   'entitlements', struct, util.genUUID(), addDistCBSuccess, addDistCBFailure); 
                });
        }

        function createOverrideCBFailure(error) {
            console.log('createOverride failed with error: ' + error);
        }

        var addDistCBSuccess = function(result) {
            console.log('authorizations_detail addDistCBSuccess');
            odkData.changeAccessFilterOfRow('entitlements', 'HIDDEN', user, result.getRowId(0), finalFilterSuccess, finalFilterFailure);
            $('#search_results').text('Override Successfully Created');
            $('#launch').prop('disabled', true);
        };

        var addDistCBFailure = function(error) {
            console.log('authorizations_detail addDistCBFailure: ' + error);
        };

        function finalFilterSuccess(result) {
            console.log('final filter success');
        }

        function finalFilterFailure(error) {
            console.log('final filter failure with error: ' + error);
        }

        </script>
    </head>


    
    <body onload="display();">
        <div id="main">           
            <h2 id="header"></h2>
            <div id="enter_code" style='text-align: center'><input id="code" style='margin: auto' style='font-size: 20px'></input></div>
            <button id='search'>Enter</button>
            <p><span id="search_results"></span></p>
            <button id="launch" style='display:none'style='font-size: 25px'></button>
        </div>
    </body>