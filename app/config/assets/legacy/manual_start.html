<html>
    <head>
        <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
        <link href="css/index.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="libs/jquery.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>
        <script type="text/javascript" src="../../config/assets/js/util.js"></script>
        <script type="text/javascript">

        var code = null;
        var id = null;
        var finished = false;
        var activeAuths = null;
        var authIndex = 1;



        function display() {
            var enter = $('#search');
            /*setTimeout(function() {
                var width = $(window).innerWidth();
                var height = $(window).innerHeight();
                document.getElementById("enter").style.width = width * .9 + "px";
                document.getElementById("enter").style.height = height * .15 + "px";
                document.getElementById("launch").style.width = width * .9 + "px";
                document.getElementById("launch").style.height = height * .15 + "px";
                document.getElementById('code').style.width = width * .6 + "px";
                document.getElementById('code').style.height = height * .07 + 'px';
            }, 0);*/
            
            enter.on('click', function() {
                code = $('#code').val();
                if (code !== "") {
                    check();
                }
            });
        }

        function check() {
            odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, 'true'], null, null,
                                null, null, null, null, true, beneficiaryCBSuccess, 
                                beneficiaryCBFailure);
        }

        function beneficiaryCBSuccess(result) {
            console.log('beneficiaryCBSuccess called');
            if (result.getCount() === 0) {
                odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, 'false'],
                    null, null, null, null, null, null, true, disabledCBSuccess, disabledCBFailure);
            } else if (result.getCount() === 1) {
                $('#launch').show();
                $('#launch').text('Click to Deliver');
                $('#launch').click(function() {
                    odkTables.openDetailView(
                  'registration',
                  result.getRowId(0),
                  'config/tables/registration/html/registration_detail.html');
                });
                odkCommon.removeFirstQueuedAction();
            } else {
                $('#search_results').text(code + ' -- Multiple Active Beneficiaries Detected!');
                $('#launch').show();
                $('#launch').text('Choose a specific beneficiary');
                $('#launch').click(function() {
                    odkTables.openTableToListView(
                    'registration', 'beneficiary_code = ? and is_active = ?', [code,'true']
                    , 'config/tables/registration/html/registration_list.html');
                });
                odkCommon.removeFirstQueuedAction();                
            }
        }

        function beneficiaryCBFailure(error) {
            console.log('beneficiaryCBFailure called with error: ' + error);
        }

        function disabledCBSuccess(result) {
            console.log('disabledCB called');
            if (result.getCount() > 0) {
                $('#search_results').text('beneficiary with code ' + ' is disabled');
            } else {
                $('#search_results').text('Scanned code not found in system');

            }
            $('#launch').hide();
            odkCommon.removeFirstQueuedAction();
        }

        function disabledCBFailure(error) {
            console.log('disableCB failed with error: ' + error);
        }

        </script>
    </head>


    
    <body onload="display();">
        <div id="main">           
            <h2>Please Enter Beneficiary Code</h2>
            <div id="enter_code" style='text-align: center'><input id="code" style='margin: auto' style='font-size: 20px'></input></div>
            <button id='search'>Enter</button>
            <p><span id="search_results"></span></p>
            <button id="launch" style='display:none'style='font-size: 25px'></button>
        </div>
    </body>