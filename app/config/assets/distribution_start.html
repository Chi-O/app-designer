<html>
    <head>
        <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
        <link href="css/index.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="libs/jquery.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>
        <script type="text/javascript">
		
        var insideQueue = false;
		var htmlFileNameValue = "distribution_start";
		var userActionValue = "launchBarcode";
    	var myTimeoutVal = null;
       	var code = null;
       	var inactiveVoucherResultSet = {};
       	var activeVoucherResultSet = {};



		function display() {
			var launchBarcodeButton = $('#launch-barcode');
    		launchBarcodeButton.on(
        	'click',
        	function() {
            	odkCommon.registerListener(function() {
                	    callBackFn();
            	});

            	var dispatchString = JSON.stringify({htmlPath:htmlFileNameValue, userAction:userActionValue});
            	odkCommon.doAction(dispatchString, 'com.google.zxing.client.android.SCAN', null);
        	});
      	    myTimeoutVal = setTimeout(callBackFn(), 1000);
    	}


    	function callBackFn () {
		    if (insideQueue == true) return;
		    insideQueue = true;
		    var value = odkCommon.viewFirstQueuedAction();
		    console.log('callback entered with value: ' + value);
		    if ( value !== null && value !== undefined ) {
		        var action = JSON.parse(value);
		        var dispatchStr = JSON.parse(action.dispatchString);

		        console.log("callBackFn: action: " + dispatchStr.userAction + " htmlPath: " + dispatchStr.htmlPath);

		        if (dispatchStr.userAction === userActionValue &&
		            dispatchStr.htmlPath === htmlFileNameValue &&
		            action.jsonValue.status === -1) {
		        	code = action.jsonValue.result.SCAN_RESULT;
		        	clearTimeout(myTimeoutVal);
		            odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, 'true'], null, null,
					            null, null, null, null, true, beneficiaryCBSuccess, 
					            beneficiaryCBFailure);

		            /*$('#scanned-barcode').text(code);
		         	odkTables.openTableToListView(
			        	'distribution',
			        	'beneficiary_code = ? and is_distributed = ?',
			        	[action.jsonValue.result.SCAN_RESULT, '0'],
			        	'config/tables/distribution/html/dist_ben_list.html'
			       	);*/
		        } else {
		            myTimeoutVal = setTimeout(callBackFn(), 1000);
		            $('#scanned-barcode').text("No value");
		        }
		    }
    		console.log("callBackFn is called");
    		insideQueue = false;
		} 

		function beneficiaryCBSuccess(result) {
			console.log('beneficiaryCBSuccess called');
			if (result.getCount() === 0) {
				odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, 'false'],
					null, null, null, null, null, null, true, disabledCBSuccess, disabledCBFailure);
			} else if (result.getCount() === 1) {
				$('#scanned-barcode').text(code);
				$('#launch').show();
				$('#launch').text('Click to Distribute');
				$('#launch').click(function() {
					odkTables.openDetailView(
                  'registration',
                  result.getRowId(0),
                  'config/tables/registration/html/registration_detail.html');
				});
				odkCommon.removeFirstQueuedAction();
			} else {
				$('#scanned-barcode').text(code + ' -- Multiple Active Beneficiaries Detected!');
				$('#launch').show();
				$('#launch').text('Choose a specific beneficiary');
				$('#launch').click(function() {
					odkTables.openTableToListView(
                	'registration', 'beneficiary_code = ? and is_active = ?', [code,'true']
                	, 'config/tables/registration/html/registration_list.html');
            	});
				odkCommon.removeFirstQueuedAction();                
			}
		}

		function beneficiaryCBFailure(error) {
			console.log('beneficiaryCBFailure called with error: ' + error);
		}

		function disabledCBSuccess(result) {
			console.log('disabledCB called');
			if (result.getCount() > 0) {
				$('#scanned-barcode').text('beneficiary with code ' + ' is disabled');
				$('#launch').hide();
				odkCommon.removeFirstQueuedAction();
			} else {
				odkData.query('distribution', 'beneficiary_code = ? and is_distributed = ?', [code, 'false'], null, null,
					null, null, null, null, true, activeVoucherCBSuccess, activeVoucherCBFailure);
			}
		}

		function disabledCBFailure(error) {
			console.log('disableCB failed with error: ' + error);
		}

		function activeVoucherCBSuccess(result) {
			activeVoucherResultSet = result;
			if (activeVoucherResultSet.getCount() < 1) {
				odkData.query('distribution', 'beneficiary_code = ? and is_distributed = ?', [code, 'true'], null, null,
					null, null, null, null, true, voucherCBSuccess, voucherCBFailure);
			} else if (activeVoucherResultSet.getCount() == 1) {
				$('#scanned-barcode').text(code + ' -- Voucher detected!');
				$('#launch').text('Click to Distribute Voucher');
				$('#launch').show();
				$('#launch').click(function() {
					odkTables.openDetailView(
					'distribution',
              		activeVoucherResultSet.getRowId(0),
              		'config/tables/distribution/html/dist_ben_detail.html');
          		});
				odkCommon.removeFirstQueuedAction();
			} else {
				$('#scanned-barcode').text(code + ' -- Multiple vouchers detected!');
				$('#launch').text('Click to choose specific voucher');
				$('#launch').show();
				$('#launch').click(function() {
					odkTables.openTableToListView(
	              		'distribution',
	              		'beneficiary_code = ? and is_distributed = ?',
	              		[registrationResultSet.get('beneficiary_code'), 'false'],
	              		'config/tables/distribution/html/dist_ben_list.html');
				});
				odkCommon.removeFirstQueuedAction();
			}
		}

		function activeVoucherCBFailure(error) {
			console.log('activeVoucherCBFailure called with error: ' + error);
		}

		function voucherCBSuccess(result) {
			inactiveVoucherResultSet = result;
			console.log(inactiveVoucherResultSet);
			if (inactiveVoucherResultSet.getCount() < 1) {
					$('#scanned-barcode').text('Scanned code not found in system');
					$('#launch').hide();
			} else { 
				$('#scanned-barcode').text('Scanned voucher has already been distributed');
				$('#launch').hide();
			}
			odkCommon.removeFirstQueuedAction();
		}

		function voucherCBFailure(error) {
			console.log('voucherCBFailure called with error: ' + error);
		}

		var setJSONMap = function(JSONMap, key, value) {
		    if (value !== null && value !== undefined) {
		        voucherResultSet.get(key);
		        JSONMap[key] = JSON.stringify(value);
		    }
		}

		var getJSONMapValues = function() {
		    var jsonMap = {};
		    setJSONMap(jsonMap, 'beneficiary_code', voucherResultSet.get('beneficiary_code'));
		    setJSONMap(jsonMap, 'distribution_id', voucherResultSet.get('distribution_id'));
		    setJSONMap(jsonMap, 'authorization_id', voucherResultSet.get('authorization_id'));
		    setJSONMap(jsonMap, 'authorization_name', voucherResultSet.get('authorization_name'));
		    setJSONMap(jsonMap, 'item_pack_id', voucherResultSet.get('item_pack_id'));
		    setJSONMap(jsonMap, 'item_pack_name', voucherResultSet.get('item_pack_name'));
		    setJSONMap(jsonMap, 'item_description', voucherResultSet.get('item_description'));
		    setJSONMap(jsonMap, 'is_override', voucherResultSet.get('is_override'));
		    // Writing out number values needs more investigation
		    setJSONMap(jsonMap, 'ranges', voucherResultSet.get('ranges'));
		    jsonMap = JSON.stringify(jsonMap);    
	    	return jsonMap;
		};

		</script>
	</head>


	
	<body onload="display();">
	<h2>Please Scan or Enter The Beneficiary Barcode</h2>
	<button id="launch-barcode" class="btn btn-launch btn-primary btn-block btn-plotter">Launch Barcode</button>
	<p>Scanned BarCode: <span id="scanned-barcode"></span></p>
	<button id="launch" style='display:none'></button>

	</body>