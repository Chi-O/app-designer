<html>
    <head>
        <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
        <link href="css/index.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="libs/jquery.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>
        <script type="text/javascript">
		
        var insideQueue = false;
		var htmlFileNameValue = "delivery_start";
		var userActionValue = "launchBarcode";
    	var myTimeoutVal = null;
       	var code = null;



		function display() {
			var launchBarcodeButton = $('#launch-barcode');
    		launchBarcodeButton.on(
        	'click',
        	function() {
            	odkCommon.registerListener(function() {
                	    callBackFn();
            	});
            	var dispatchString = JSON.stringify({htmlPath:htmlFileNameValue, userAction:userActionValue});
            	odkCommon.doAction(dispatchString, 'com.google.zxing.client.android.SCAN', null);
        	});
      	    myTimeoutVal = setTimeout(callBackFn(), 1000);
    	}


    	function callBackFn () {
		    if (insideQueue == true) return;
		    insideQueue = true;
		    var value = odkCommon.viewFirstQueuedAction();
		    console.log('callback entered with value: ' + value);
		    if ( value !== null && value !== undefined ) {
		        var action = JSON.parse(value);
		        var dispatchStr = JSON.parse(action.dispatchString);

		        console.log("callBackFn: action: " + dispatchStr.userAction + " htmlPath: " + dispatchStr.htmlPath);

		        if (dispatchStr.userAction === userActionValue &&
		            dispatchStr.htmlPath === htmlFileNameValue &&
		            action.jsonValue.status === -1) {
		        	code = action.jsonValue.result.SCAN_RESULT;
		        	clearTimeout(myTimeoutVal);
		            odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, 'true'], null, null,
					            null, null, null, null, true, beneficiaryCBSuccess, 
					            beneficiaryCBFailure);

		        } else {
		            myTimeoutVal = setTimeout(callBackFn(), 1000);
		            $('#scanned-barcode').text("No value");
		            $('#launch').hide();
					odkCommon.removeFirstQueuedAction();
		        }
		    }
    		console.log("callBackFn is called");
    		insideQueue = false;
		} 

		function beneficiaryCBSuccess(result) {
			console.log('beneficiaryCBSuccess called');
			if (result.getCount() === 0) {
				odkData.query('registration', 'beneficiary_code = ? and is_active = ?', [code, 'false'],
					null, null, null, null, null, null, true, disabledCBSuccess, disabledCBFailure);
			} else if (result.getCount() === 1) {
				$('#scanned-barcode').text(code);
				$('#launch').show();
				$('#launch').text('Click to Deliver');
				$('#launch').click(function() {
					odkTables.openDetailView(
                  'registration',
                  result.getRowId(0),
                  'config/tables/registration/html/registration_detail.html');
				});
				odkCommon.removeFirstQueuedAction();
			} else {
				$('#scanned-barcode').text(code + ' -- Multiple Active Beneficiaries Detected!');
				$('#launch').show();
				$('#launch').text('Choose a specific beneficiary');
				$('#launch').click(function() {
					odkTables.openTableToListView(
                	'registration', 'beneficiary_code = ? and is_active = ?', [code,'true']
                	, 'config/tables/registration/html/registration_list.html');
            	});
				odkCommon.removeFirstQueuedAction();                
			}
		}

		function beneficiaryCBFailure(error) {
			console.log('beneficiaryCBFailure called with error: ' + error);
		}

		function disabledCBSuccess(result) {
			console.log('disabledCB called');
			if (result.getCount() > 0) {
				$('#scanned-barcode').text('beneficiary with code ' + ' is disabled');
			} else {
				$('#scanned-barcode').text('Scanned code not found in system');

			}
			$('#launch').hide();
			odkCommon.removeFirstQueuedAction();
		}

		function disabledCBFailure(error) {
			console.log('disableCB failed with error: ' + error);
		}

		</script>
	</head>


	
	<body onload="display();">
	<h2>Please Scan or Enter The Beneficiary Barcode</h2>
	<button id="launch-barcode" class="btn btn-launch btn-primary btn-block btn-plotter">Launch Barcode</button>
	<p>Scanned BarCode: <span id="scanned-barcode"></span></p>
	<button id="launch" style='display:none'></button>

	</body>