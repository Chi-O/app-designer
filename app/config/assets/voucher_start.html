<html>
    <head>
        <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
        <link href="css/index.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="libs/jquery.js"></script>
        <script type="text/javascript" src="../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../system/tables/js/odkTables.js"></script>
        <script type="text/javascript">
		
        var insideQueue = false;
		var htmlFileNameValue = "voucher_start";
		var userActionValue = "launchBarcode";
    	var myTimeoutVal = null;
       	var code = null;

		function display() {
			var launchBarcodeButton = $('#launch-barcode');
    		launchBarcodeButton.on(
        	'click',
        	function() {
            	odkCommon.registerListener(function() {
                	    callBackFn();
            	});
            	var dispatchString = JSON.stringify({htmlPath:htmlFileNameValue, userAction:userActionValue});
            	odkCommon.doAction(dispatchString, 'com.google.zxing.client.android.SCAN', null);
        	});
      	    myTimeoutVal = setTimeout(callBackFn(), 1000);
    	}

    	function callBackFn () {
		    if (insideQueue == true) return;
		    insideQueue = true;
		    var value = odkCommon.viewFirstQueuedAction();
		    console.log('callback entered with value: ' + value);
		    if ( value !== null && value !== undefined ) {
		        var action = JSON.parse(value);
		        var dispatchStr = JSON.parse(action.dispatchString);

		        console.log("callBackFn: action: " + dispatchStr.userAction + " htmlPath: " + dispatchStr.htmlPath);

		        if (dispatchStr.userAction === userActionValue &&
		            dispatchStr.htmlPath === htmlFileNameValue &&
		            action.jsonValue.status === -1) {
		        	code = action.jsonValue.result.SCAN_RESULT;
		        	clearTimeout(myTimeoutVal);
		            odkData.query('registration', 'beneficiary_code = ?', [code], null, null,
					            null, null, null, null, true, beneficiaryCBSuccess, beneficiaryCBFailure);
		        } else {
		            myTimeoutVal = setTimeout(callBackFn(), 1000);
		            $('#scanned-barcode').text("No value");
		        }
		    }
    		console.log("callBackFn is called");
    		insideQueue = false;
		} 

		function beneficiaryCBSuccess(result) {
			console.log('beneficiaryCBSuccess called');
			if (result.getCount() === 0) {
				odkData.query('entitlements', 'beneficiary_code = ?', [code],
					null, null, null, null, null, null, true, voucherCBSuccess, voucherCBFailure);
			} else {
				$('#scanned-barcode').text(code + " -- beneficiary with this code already detected in system: please contact Administrator");
			}
		}

		function beneficiaryCBFailure(error) {
			console.log('beneficiaryCBFailure called with error: ' + error);
		}

		function voucherCBSuccess(result) {
			console.log('voucherCBSuccess called');
			if (result.getCount() === 0) {
				$('#scanned-barcode').text('Scanned voucher code not found in system');
			} else {
				$('#scanned-barcode').text(code + ' -- Voucher Detected!');
				$('#launch').show();
				$('#launch').text('Redeem Voucher');
				$('#launch').click(function() {
					odkTables.addRowWithSurvey(
                	'registration', 'registration', null, getJSONMapValues());
            	});
			}
			odkCommon.removeFirstQueuedAction();
		}

		function voucherCBFailure(error) {
			console.log('activeCBFailure called with error: ' + error);
		}

		var setJSONMap = function(JSONMap, key, value) {
		    if (value !== null && value !== undefined) {
		        JSONMap[key] = JSON.stringify(value);
		    }
		}

		var getJSONMapValues = function() {
		    var jsonMap = {};
		    setJSONMap(jsonMap, 'beneficiary_code', code);
		    jsonMap = JSON.stringify(jsonMap);    
	    	return jsonMap;
		};

		</script>
	</head>


	
	<body onload="display();">
	<h2>Please Scan or Enter The Voucher Barcode</h2>
	<button id="launch-barcode" class="btn btn-launch btn-primary btn-block btn-plotter">Launch Barcode</button>
	<p>Scanned BarCode: <span id="scanned-barcode"></span></p>
	<button id="launch" style='display:none'></button>

	</body>