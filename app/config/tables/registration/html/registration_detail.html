<!DOCTYPE html>
<html>
    <head>
        <link href="../../../assets/css/detail.css" type="text/css" rel="stylesheet" />
        <script type="text/javascript" src="../../../assets/libs/jquery.js"></script>
        <script type="text/javascript" src="../../../../system/js/odkCommon.js"></script>
        <script type="text/javascript" src="../../../../system/js/odkData.js"></script>
        <script type="text/javascript" src="../../../../system/tables/js/odkTables.js"></script>
        <script type="text/javascript" src="../../../assets/js/util.js"></script>
        <script type="text/javascript">

            'use strict';
             
            var registrationResultSet = {};
            var type = util.getQueryParameter('type');

            function cbSuccess(result) {

              registrationResultSet = result;
              var first_name = registrationResultSet.get('first_name');
              var last_name = registrationResultSet.get('last_name');
              $('#TITLE').text(first_name + ' ' + last_name);

              $('#beneficiary_code').text(registrationResultSet.get('beneficiary_code'));

              $('#sector').text(registrationResultSet.get('sector'));

              $('#address').text(registrationResultSet.get('address'));
              $('#id_number').text(registrationResultSet.get('id_number'));
              $('#city').text(registrationResultSet.get('city'));

              $('#telephone').text(registrationResultSet.get('telephone'));
              $('#mobile_provider').text(registrationResultSet.get('mobile_provider'));

            if (registrationResultSet.get('is_active') == 'true' && type == 'delivery') {
                odkData.query('entitlements', 'beneficiary_code = ? and is_delivered = ?',
                            [registrationResultSet.get('beneficiary_code'), 'false'],
                            null, null, null, null, null, null, null, entCBSuccess, entCBFailure);
            }  else if (registrationResultSet.get('is_active') == 'false' && type == 'delivery') {
                $('#reject').text('Beneficiary is Disabled');
            } else {
                var action = $('#followup');
                if (type == 'activate') {
                  action.text('Enable Beneficiary');
                } else {
                  action.text('Disable Beneficiary');
                }
                action.show();
                action.on(
                  'click',
                  function() {
                    var struct = {};
                    if (type == 'activate') {
                      struct.is_active = 'true';
                    } else {
                      struct.is_active = 'false';
                    }
                    struct.is_override = 'true';
                    odkData.updateRow(
                      'registration', struct, registrationResultSet.getRowId(0), updateCBSuccess, updateCBFailure);
                  }
                );
              }
            }

            function cbFailure(error) {
              console.log('registration_detail cbFailure: getViewData failed with message: ' + error);
            }

            function updateCBSuccess(result) {
              console.log('Update is_active callback success');
              $("#followup").prop("disabled",true);
              if (type == 'activate') {
                $('#message').text('Successfully Enabled!');
              } else {
                  $('#message').text('Successfully Disabled!');
              }
            }

            function updateCBFailure(result) {
              console.log('Update is_active callback failure');
            }

            function entCBSuccess(result) {
              if (result.getCount() > 0) {
                console.log(result.getCount());
                var deliver = $('#followup');
                deliver.text('Choose an Entitlement To Deliver');
                deliver.show();
                deliver.on(
                    'click',
                    function() {
                        odkTables.openTableToListView(
                            'entitlements',
                            'beneficiary_code = ? and is_delivered = ?',
                            [registrationResultSet.get('beneficiary_code'), 'false'],
                            'config/tables/entitlements/html/dist_ben_list.html'
                        );
                    }
                );
              } else {
                console.log('rejected');
                $('#reject').text('No Entitlements to Deliver');
              }
            }

            function entCBFailure(error) {
              console.log('entCBFailure with error: ' + error);
            }

            function display() {
              odkData.getViewData(cbSuccess, cbFailure);
            }



        </script>


    </head>
    <body onload="display();">
        <h1><span id="TITLE" class="main-text"></span></h1>
        <!-- To query and link to the result, replace the placeholders and put the
        following around the <span></span> tags.
        <a href="#" onclick="control.openTable('TABLE_NAME', 'COL_NAME:' +
        data.get('COL_NAME'));"></a>
        
        Example:<a href="#" onclick="control.openTable('TABLE_NAME',
        'COL_NAME:' + data.get('COL_NAME'));"><span id="FIELD_1"></span></a>
        -->
        <p>Beneficiary Code: <span id="beneficiary_code"></span></p>
        <p>Sector: <span id="sector"></span></p>
        <p>ID: <span id="id_number"></span></p>
        <p>Address: <span id="address"></span></p>
        <p>Telephone: <span id="telephone"></span></p>
        <p>Mobile Provider: <span id="mobile_provider"></span></p>
        <p><span id="reject"></span></p>
        </br>

        <button id="followup" style="display:none"></button>
        <p><span id="message"></span></p>
    </body>
</html>
